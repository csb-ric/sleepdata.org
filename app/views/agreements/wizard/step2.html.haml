= render 'agreements/wizard/daua_progress'

%h2.center SPECIFIC PURPOSE

%hr.divider-md

= form_for @agreement, url: update_step_agreement_path(@agreement), method: :patch, html: { class: 'form-vertical', id: 'update_step_form' } do |f|
  - if @agreement.errors.any?
    #error_explanation.bs-callout.bs-callout-danger
      %h4
        = pluralize(@agreement.errors.count, "error")
        prohibited this step from being saved

      %ul
        - @agreement.errors.full_messages.each do |msg|
          %li= msg

  = hidden_field_tag "agreement[draft_mode]", nil
  = hidden_field_tag "step", @step
  = hidden_field_tag "agreement[current_step]", @step

  = render 'agreements/show/step2/part1'

  .row{ style: "margin-top: 20px;margin-bottom: 20px;" }
    .col-md-10.col-md-offset-1
      .bs-callout.bs-callout-info
        %h4 Instructions

        %p
          Please provide enough detail about your research and how you intend to
          use the data. All requests are reviewed for appropriateness based on
          the description provided.

          %strong Select only those datasets needed for your project.

          Incomplete descriptions will result in delays in granting access.

  .form-group
    = f.label :title_of_project, 'Title Of Project', class: 'control-label'
    = f.text_field :title_of_project, class: 'form-control'

  .form-group
    = f.label :specific_purpose, 'Specific Purpose', class: 'control-label'
    = f.text_area :specific_purpose, rows: '5', class: 'form-control', placeholder: "Be specific! (More than 20 words required.)"

  .form-group
    = f.label :dataset_ids, 'Select a Dataset', class: 'control-label'
    .row
      = hidden_field_tag "agreement[dataset_ids][]", 0
      - Dataset.release_scheduled.each do |dataset|
        - dataset_included = @agreement.datasets.pluck(:id).include?(dataset.id)
        .col-xs-6.col-sm-4.col-md-3
          .panel.panel-hover{ class: "#{dataset_included ? 'panel-success' : 'panel-default'}", data: { object: "select_checkbox_panel", target: "#agreement_dataset_ids_#{dataset.id}" } }
            .panel-heading{ style: "overflow:hidden" }
              %h3.panel-title{ style: "white-space:nowrap" }
                = check_box_tag "agreement[dataset_ids][]", dataset.id, dataset_included, id: "agreement_dataset_ids_#{dataset.id}"
                = dataset.name
            .panel-body
              .center{ style: "background-color:white;padding-bottom:5px;height:75px;line-height:75px" }
                - if dataset.logo.size > 0
                  = image_tag( logo_dataset_path(dataset), style: 'max-width:100%;max-height:70px' )
                - else
                  = image_tag( 'project-default-logo.png', style: 'max-width:100%;max-height:70px' )

  #too-many-datasets{ style: "#{'display:none' if @agreement.datasets.count < 2}" }
    .alert.alert-warning
      %p.lead
        %strong Heads Up!
        Make sure you have only selected the datasets appropriate for your
        = succeed '.' do
          %i Specific Purpose
        You will be asked to resubmit if you request too many datasets.

  .form-group
    = f.label :intended_use_of_data, 'Intended Use Of Data', class: 'control-label'
    = f.text_field :intended_use_of_data, class: 'form-control'
    .bs-callout.bs-callout-info
      %p
        %strong Examples:
        Publication; thesis work; other education; algorithm for commercial
        use; preliminary data for a grant.


  .form-group
    = f.label :data_secured_location, 'Please describe where data will be stored and secured', class: 'control-label'
    = f.text_field :data_secured_location, class: 'form-control'

  .form-group
    = f.label :secured_device, 'Security', class: 'control-label'
    .checkbox
      %label
        = f.check_box :secured_device
        I attest that data will be stored on a secure password protected device.

  .form-group
    = f.label :human_subjects_protections_trained, 'HIPAA Training', class: 'control-label'
    .checkbox
      %label
        = f.check_box :human_subjects_protections_trained
        I attest that I have completed a Human Subjects Protections Training Course.

    .bs-callout.bs-callout-info
      %strong Don't have Human Subjects Protections Training?
      You may sign up and complete a course at these links:
      %ul
        %li= link_to 'http://www.hrsa.gov/publichealth/clinical/HumanSubjects/', 'http://www.hrsa.gov/publichealth/clinical/HumanSubjects/'
        %li= link_to 'http://grants.nih.gov/grants/policy/hs/training.htm', 'http://grants.nih.gov/grants/policy/hs/training.htm'
        %li= link_to 'http://irtsectraining.nih.gov/publicUser0.aspx', 'http://irtsectraining.nih.gov/publicUser0.aspx'

  = render 'agreements/show/step2/part2'

  %hr.divider-md

  .row
    .col-xs-4
      = link_to step_agreement_path(@agreement, step: @step-1), class: 'btn btn-lg btn-default btn-block' do
        %span.glyphicon.glyphicon-arrow-left
        Back to Previous Step
    .col-xs-4
      = link_to '#', data: { object: 'submit-draft', target: '#update_step_form' }, class: 'btn btn-lg btn-warning btn-block' do
        %span.glyphicon.glyphicon-floppy-disk
        Save Draft
    .col-xs-4
      = link_to '#', data: { object: 'submit', target: '#update_step_form' }, class: 'btn btn-lg btn-primary btn-block' do
        %span.glyphicon.glyphicon-floppy-disk
        Save and Continue

- @footer_img = 'footer.jpg'
