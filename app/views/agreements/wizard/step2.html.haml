= render 'agreements/wizard/daua_progress'

%h2.center SPECIFIC PURPOSE

%hr.divider-md

= form_for @agreement, url: update_step_agreement_path(@agreement), method: :patch, html: { class: 'form-vertical', id: 'update_step_form' } do |f|
  - if @agreement.errors.any?
    #error_explanation.bs-callout.bs-callout-danger
      %h4
        = pluralize(@agreement.errors.count, "error")
        prohibited this step from being saved

      %ul
        - @agreement.errors.full_messages.each do |msg|
          %li= msg

  = hidden_field_tag "agreement[draft_mode]", nil
  = hidden_field_tag "step", @step
  = hidden_field_tag "agreement[current_step]", @step

  = render 'agreements/show/step2/part1'

  .row{ style: "margin-top: 20px;margin-bottom: 20px;" }
    .col-md-10.col-md-offset-1
      .bs-callout.bs-callout-info
        %h4 Instructions

        %p
          Please describe your research in detail, how it relates to the
          datasets you are requesting, which variables you will be looking at,
          and the goal of your research.

        %p
          %strong
            This single response plays an important role in determing
            whether or not you will be granted access to the data.

        %p
          If you have
          %strong NOT
          explored the variables for datasets on the NSRR, it is STRONGLY
          recommended you become familiar with them before requesting access.
          You can explore
          = succeed '.' do
            = link_to 'all the datasets here', datasets_path

  .form-group
    = f.label :title_of_project, 'Title Of Project', class: 'control-label'
    = f.text_field :title_of_project, class: 'form-control'

  .form-group
    = f.label :specific_purpose, 'Specific Purpose', class: 'control-label'
    = f.text_area :specific_purpose, rows: '5', class: 'form-control', placeholder: "Explain Specific Purpose: (More than 20 words required.)"

  .row
    = hidden_field_tag "agreement[dataset_ids][]", 0
    - Dataset.release_scheduled.each do |dataset|
      - dataset_included = @agreement.datasets.pluck(:id).include?(dataset.id)
      .col-xs-6.col-sm-4.col-md-3
        .panel.panel-hover{ class: "#{dataset_included ? 'panel-success' : 'panel-default'}", data: { object: "select_checkbox_panel", target: "#agreement_dataset_ids_#{dataset.id}" } }
          .panel-heading{ style: "overflow:hidden" }
            %h3.panel-title{ style: "white-space:nowrap" }
              = check_box_tag "agreement[dataset_ids][]", dataset.id, dataset_included, id: "agreement_dataset_ids_#{dataset.id}"
              = dataset.name
          .panel-body
            .center{ style: "background-color:white;padding-bottom:5px;height:75px;line-height:75px" }
              - if dataset.logo.size > 0
                = image_tag( logo_dataset_path(dataset), style: 'max-width:100%;max-height:70px' )
              - else
                = image_tag( 'project-default-logo.png', style: 'max-width:100%;max-height:70px' )

  #too-many-datasets{ style: "#{'display:none' if @agreement.datasets.count < 2}" }
    .alert.alert-warning
      %p.lead
        %strong Heads Up!
        Make sure you have only selected the datasets appropriate for your
        = succeed '.' do
          %i Specific Purpose
        You will be asked to resubmit if you request too many datasets.

  = render 'agreements/show/step2/part2'

  %hr.divider-md

  .row
    .col-xs-4
      = link_to step_agreement_path(@agreement, step: @step-1), class: 'btn btn-lg btn-default btn-block' do
        %span.glyphicon.glyphicon-arrow-left
        Back to Previous Step
    .col-xs-4
      = link_to '#', data: { object: 'submit-draft', target: '#update_step_form' }, class: 'btn btn-lg btn-warning btn-block' do
        %span.glyphicon.glyphicon-floppy-disk
        Save Draft
    .col-xs-4
      = link_to '#', data: { object: 'submit', target: '#update_step_form' }, class: 'btn btn-lg btn-primary btn-block' do
        %span.glyphicon.glyphicon-floppy-disk
        Save and Continue

- @footer_img = 'footer.jpg'
