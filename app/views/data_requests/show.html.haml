-# TODO: Set expired...
-# Tests for each submission type + expired + expired with date (but approved)
-# if @data_request.expired?
-# TODO: "Started" data requests should redirect to page/1 or appropriate page.

- @title = "Data Requests"

.float-right
  = link_to [:print, @data_request], data: { turbolinks: false }, class: "btn btn-outline-dark btn-sm" do
    %i.fa.fa-print
    Print

= link_to data_requests_path, class: "btn btn-sm mb-3" do
  %i.fa.fa-caret-left
  Back to Data Requests

.card
  - case @data_request.status
  - when "started"

    - progress = @data_request.progress
    - resume_url = nil

    %h4.card-header
      Started
    .card-body{ style: "position: relative;" }
      .data-requests-progress-bar{ style: "width: #{progress}%;" }

      .row
        .col.mb-3

          %strong= @data_request.final_legal_document.name
          %ul.list-unstyled
            - @data_request.final_legal_document.final_legal_document_pages.each do |final_legal_document_page|
              - page_complete = @data_request.page_complete?(final_legal_document_page)
              - resume_url = data_requests_page_path(@data_request, final_legal_document_page.position) unless page_complete || resume_url.present?
              %li
                - if page_complete
                  %i.fa.fa-check-square-o.text-success
                - else
                  %i.fa.fa-square-o
                = link_to "Page #{final_legal_document_page.position}", data_requests_page_path(@data_request, final_legal_document_page.position), class: "link-unstyled"

            - if @data_request.attestation_required?
              %li
                - if @data_request.attestation_complete?
                  %i.fa.fa-check-square-o.text-success
                - else
                  %i.fa.fa-square-o
                = link_to @data_request.final_legal_document.attestation_name, data_requests_attest_path(@data_request), class: "link-unstyled"

        .col.mb-0
          %strong
            = link_to "Supporting Documents", data_request_supporting_documents_path(@data_request), class: "link-unstyled"

            %span.badge.badge-primary= @data_request.supporting_documents.count

      = render "data_requests/description", data_request: @data_request

    .card-footer
      .float-right
        - if resume_url.nil?
          = link_to data_requests_proof_path(@data_request) do
            Proof and submit
            %i.fa.fa-caret-right
        - else
          = link_to resume_url do
            Resume
            %i.fa.fa-caret-right

      = name_of_datasets(@data_request)

  - when "submitted"
    %h4.card-header
      - if @data_request.resubmitted?
        Resubmitted
      - else
        Submitted

    .card-body
      .mb-5
        %strong= @data_request.final_legal_document.name

      .row.mb-5
        = render "data_requests/timeline/submitted", data_request: @data_request
        = render "data_requests/timeline/resubmitted", data_request: @data_request if @data_request.resubmitted?
        = render "data_requests/timeline/under_review", data_request: @data_request


      = render "data_requests/description", data_request: @data_request

    .card-footer= name_of_datasets(@data_request)

  - when "resubmit"
    %h4.card-header
      Changes Required

    .card-body
      .mb-5
        %strong= @data_request.final_legal_document.name

      .row.mb-5
        = render "data_requests/timeline/submitted", data_request: @data_request
        = render "data_requests/timeline/resubmit", data_request: @data_request

      = render "data_requests/resubmit_description", data_request: @data_request



      = render "data_requests/description", data_request: @data_request



    .card-footer
      .float-right
        -# TODO: Better resume links
        = link_to data_requests_page_path(@data_request, 1) do
          Update data request
          %i.fa.fa-caret-right
      = name_of_datasets(@data_request)

  - when "approved"
    %h4.card-header
      .float-right
        %i.fa.fa-check-square.text-success
      Approved
    .card-body
      .mb-5
        %strong= @data_request.final_legal_document.name

      .row.mb-5
        = render "data_requests/timeline/submitted", data_request: @data_request
        = render "data_requests/timeline/resubmitted", data_request: @data_request if @data_request.resubmitted?
        = render "data_requests/timeline/approved", data_request: @data_request

      = render "data_requests/description", data_request: @data_request
    .card-footer= name_of_datasets(@data_request)

  - when "closed"
    %h4.card-header
      %i.fa.fa-lock
      Closed
    .card-body
      %p.lead
        This data request is closed.
    .card-footer= name_of_datasets(@data_request)
  - else # "expired"
    %h4.card-header
      %i.fa.fa-hourglass-end
      Expired
    .card-body
      %p.lead
        This data request is expired.
      = render "data_requests/datasets", data_request: @data_request
    .card-footer
      -# TODO: Fix "renew data request path"
      = link_to "Renew Data Request", data_requests_start_path(@data_request.datasets.first)
