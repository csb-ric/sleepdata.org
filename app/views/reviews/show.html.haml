- @title = @data_request.name

- content_for :header do
  .header-container
    .container
      %h1.page-heading
        .float-right
          = link_to transactions_review_path(@data_request), class: "btn btn-light btn-sm" do
            %i.fa.fa-th-list
            Transactions
          - if current_user.all_data_requests.where(id: @data_request.id).count > 0
            &nbsp;
            = link_to print_agreement_path(@data_request), class: "btn btn-light btn-sm", data: { turbolinks: false } do
              %i.fa.fa-print
              Print

        = @title
  .breadcrumb-container.mb-0
    .container
      .float-right.d-none.d-lg-block
        = render "reviews/tags", data_request: @data_request
      %ol
        %li
          = link_to reviews_path, class: "btn btn-sm btn-light" do
            %i.fa.fa-caret-left
            Reviews
        %span#agreement-reviewers= render "reviews/reviewers", data_request: @data_request

.float-right

%div{ style: "clear: both;" } &nbsp;
- other_data_requests = @data_request.user.data_requests.where.not(id: @data_request.id).where(status: %w(submitted resubmit approved expired))
- if other_data_requests.count > 0
  .comment_outer
    .comment-right-fluid
      %div{ style: "padding: 20px;" }
        %p
          This user has
          = other_data_requests.count
          other
          = succeed ":" do
            = "data request#{"s" if other_data_requests.count > 1}"

        %ul.list-unstyled
          - other_data_requests.each do |a|
            %li{ style: "padding-bottom: 5px;" }
              = status_helper(a)
              = link_to a.name_with_id, review_path(a), class: "callout-link"
              - a.datasets.order(:release_date, :name).each do |dataset|
                = render "datasets/mini", dataset: dataset

#agreement_events
  = render "agreement_events/index"

#agreement_events_new_form
  - @agreement_event = @data_request.agreement_events.where(user_id: current_user.id).new
  = render "agreement_events/form"

.page-box.last-box
  .container
    - if @data_request.final_legal_document

      - @data_request.final_legal_document.final_legal_document_variables.each do |variable|
        - agreement_variable = @data_request.agreement_variables.find_by(final_legal_document_variable_id: variable.id)
        - value = (agreement_variable ? agreement_variable.value : "")

        - if variable.variable_type == "checkbox"
          - content = simple_check(value == "1")
        - else
          - content = (agreement_variable ? agreement_variable.value : "")
        - display_name = variable.display_name.present? ? variable.display_name : variable.name.titleize
        -# TODO: || true should be removed and variables should be set as required or not.
        - if (variable.required? || true) && content.blank?
          - display_name = "<div class=\"text-danger\">#{display_name}</div>".html_safe
          - if variable.variable_type == "checkbox"
            - content = "<div class=\"text-danger\">#{content}</div>".html_safe
          - else
            - content = "<span class=\"legal-document-variable-missing-content\">&nbsp;</span>".html_safe
        = render "forms/horizontal/show/generic", title: display_name, content: content

      - if @data_request.final_legal_document.attestation_type == "signature"
        - if @data_request.signature_file.path
          - content = image_tag(signature_review_path(@data_request), class: "img-signature", alt: "")
        - else
          - content = "<div class=\"text-muted\">No signature</div>".html_safe
        = render "forms/horizontal/show/generic", title: "Signature", content: content


      - @data_request.final_legal_document.final_legal_document_pages.each do |page|
        = legal_markdown page, reviewer: true

    - else
      No Final Legal Document
