- @title = 'Reviews'

- content_for :body_class do
  gray-background

.row
  .col-md-3
    = render 'internal/profile'
    .dashboard-link
      = link_to admin_dashboard_path do
        %span.glyphicon.glyphicon-arrow-left
        Back to Admin Dashboard

    .dashboard-container
      .dashboard-title
        %strong= @title
      %p All your admin needs.


  .col-md-9
    .dashboard-container
      .dashboard-title
        %strong= @title

      = render 'contour/layouts/per_page', per_page: 40, object_count: @agreements.total_count, pagination_size: 'small'

      = form_tag reviews_path, method: :get, class: 'form-inline' do
        = text_field_tag 'search', params[:search], class: 'form-control'
        .form-group
          = label :status, 'Status'
          = select_tag :status, options_for_select([['---', nil]] + Agreement::STATUS, params[:status].is_a?(Array) ? nil : params[:status]), class: 'form-control'

        .form-group
          = label :tag_id, 'Tag'
          = select_tag :tag_id, options_for_select([['---', nil]] + Tag.review_tags.pluck(:name, :id), params[:tag_id].is_a?(Array) ? nil : params[:tag_id]), class: 'form-control'

        = submit_tag 'Search', class: 'btn btn-primary', name: nil
        = link_to 'Reset', reviews_path, class: 'btn btn-default'
        - if current_user.system_admin?
          = link_to export_agreements_path( format: 'csv' ), class: 'btn btn-xs btn-default' do
            %span.glyphicon.glyphicon-csv
            Export CSV

      .table-responsive
        %table.table.table-striped
          %thead
            %tr
              %th
                = link_to 'Status', reviews_path( order: (params[:order] == 'agreements.status DESC' ? 'agreements.status' : 'agreements.status DESC'), status: params[:status], tag_id: params[:tag_id], search: params[:search] )
              %th
                = link_to 'Agreement', reviews_path( order: (params[:order] == 'agreements.id DESC' ? 'agreements.id' : 'agreements.id DESC'), status: params[:status], tag_id: params[:tag_id], search: params[:search] )
              %th.nowrap
                = link_to 'Submission Date', reviews_path( order: (params[:order] == 'agreements.last_submitted_at DESC' ? 'agreements.last_submitted_at' : nil), status: params[:status], tag_id: params[:tag_id], search: params[:search] )
              %th Reviewers
              %th Datasets
              %th Tags

          - @agreements.each do |agreement|
            %tr
              %td= status_helper(agreement)
              %td.nowrap
                = image_tag agreement.user.avatar_url(18), style: 'vertical-align:text-bottom;width:18px'
                = link_to agreement.name_with_id, review_path(agreement)
              %td
                - if agreement.resubmitted_at
                  = agreement.resubmitted_at.strftime("%Y-%m-%d")
                  = link_to '#', rel: 'tooltip', title: 'Resubmitted', data: { object: 'suppress-click', container: 'body', placement: 'right' } do
                    %span.glyphicon.glyphicon-info-sign
                - elsif agreement.submitted_at
                  = agreement.submitted_at.strftime("%Y-%m-%d")
              %td.nowrap= render 'reviews/reviewers', agreement: agreement
              %td
                - agreement.datasets.order(:release_date, :name).each do |dataset|
                  = render 'datasets/mini', dataset: dataset
              %td= render 'reviews/tags', agreement: agreement

      .center
        = paginate @agreements, theme: 'contour-small'
