- @title = 'Reviews'

- content_for :body_class do
  gray-background

= render 'internal/profile_header', title: @title

.dashboard-container
  = render 'variables/per_page', per_page: 40, object_count: @agreements.total_count, pagination_size: 'small'

  = form_tag reviews_path, method: :get, class: 'form-inline' do
    = text_field_tag 'search', params[:search], class: 'form-control'

    = submit_tag 'Search', class: 'btn btn-primary', name: nil
    = link_to 'Reset', reviews_path, class: 'btn btn-default'
    - if current_user.system_admin?
      = link_to export_agreements_path( format: 'csv' ), class: 'btn btn-xs btn-default' do
        %span.glyphicon.glyphicon-csv
        Export CSV

  %div{ style: 'clear:both' }

  .table-responsive
    %table.table.table-striped
      %thead
        %tr
          %th
            = link_to 'Status', reviews_path(order: (params[:order] == 'agreements.status DESC' ? 'agreements.status' : 'agreements.status DESC'), status: params[:status], tag_id: params[:tag_id], search: params[:search])
            .dropdown{ style: 'display: inline-block' }
              = link_to '#', data: { target: '#', toggle: 'dropdown' }, role: 'button', aria: { haspopup: 'true', expanded: 'false' } do
                %span.glyphicon.glyphicon-filter
              %ul.dropdown-menu
                %li= link_to 'All', reviews_path(order: params[:order]), style: params[:status].blank? ? 'font-weight:bold;' : ''
                - Agreement::STATUS.each do |label, value|
                  %li= link_to label.titleize, reviews_path(order: params[:order], status: value), style: params[:status] == value ? 'font-weight:bold;' : ''
          %th
            = link_to 'Agreement', reviews_path(order: (params[:order] == 'agreements.id DESC' ? 'agreements.id' : 'agreements.id DESC'), status: params[:status], tag_id: params[:tag_id], search: params[:search])
          %th.nowrap
            = link_to 'Submitted', reviews_path(order: (params[:order] == 'agreements.last_submitted_at DESC' ? 'agreements.last_submitted_at' : nil), status: params[:status], tag_id: params[:tag_id], search: params[:search])
          %th.nowrap
            = link_to 'Expires', reviews_path(order: (params[:order] == 'agreements.expiration_date DESC' ? 'agreements.expiration_date' : 'agreements.expiration_date DESC'), status: params[:status], tag_id: params[:tag_id], search: params[:search])
          %th Reviewers
          %th Datasets
          %th
            Tags
            .dropdown{ style: 'display: inline-block' }
              = link_to '#', data: { target: '#', toggle: 'dropdown' }, role: 'button', aria: { haspopup: 'true', expanded: 'false' } do
                %span.glyphicon.glyphicon-filter
              %ul.dropdown-menu.dropdown-menu-right
                %li= link_to 'All', reviews_path(order: params[:order]), style: params[:tag_id].blank? ? 'font-weight:bold;' : ''
                - Tag.review_tags.pluck(:name, :id).each do |label, value|
                  %li= link_to label.titleize, reviews_path(order: params[:order], tag_id: value), style: params[:tag_id].to_s == value.to_s ? 'font-weight:bold;' : ''

      - @agreements.each do |agreement|
        %tr
          %td= status_helper(agreement)
          %td.nowrap
            = image_tag agreement.user.avatar_url(18), style: 'vertical-align:text-bottom;width:18px'
            = link_to agreement.name_with_id, review_path(agreement)
          %td
            - if agreement.resubmitted_at
              = agreement.resubmitted_at.strftime("%Y-%m-%d")
              = link_to '#', rel: 'tooltip', title: 'Resubmitted', data: { object: 'suppress-click', container: 'body', placement: 'right' } do
                %span.glyphicon.glyphicon-info-sign
            - elsif agreement.submitted_at
              = agreement.submitted_at.strftime("%Y-%m-%d")
          %td.nowrap
            - if agreement.expiration_date
              = agreement.expiration_date.strftime('%Y-%m-%d')
          %td.nowrap= render 'reviews/reviewers', agreement: agreement
          %td
            - agreement.datasets.order(:release_date, :name).each do |dataset|
              = render 'datasets/mini', dataset: dataset
          %td= render 'reviews/tags', agreement: agreement

  .center
    = paginate @agreements, theme: 'contour-small'
