- @title = "Reviews"

- content_for :header do
  .header-container
    .container
      %h1.page-heading
        .float-right
          = link_to download_or("Export CSV"), export_agreements_path(format: "csv"), class: "btn btn-primary btn-shadow" if current_user.system_admin?
          = render "layouts/per_page", per_page: 40, object_count: @data_requests.total_count
        = @title
        = render "search/toggle"

= render "search/simple", url: reviews_path

- if params[:voted] == "0"
  - count = @data_requests.count
  .p-3.mb-2.bg-dark.text-white.text-center
    Vote required on the following
    - if count == 1
      data request.
    - else
      data requests.
    = link_to "Show all data requests.", reviews_path

- if @data_requests.present?
  %table.table.table-striped.table-borderless.table-hover.table-sticky
    %thead.table-light
      %tr
        %th.nowrap
          = link_to "Status", reviews_path(order: (params[:order] == "agreements.status desc" ? "agreements.status" : "agreements.status desc"), status: params[:status], tag_id: params[:tag_id], search: params[:search])
          .dropdown{ style: "display: inline-block;" }
            = link_to "#", data: { target: "#", toggle: "dropdown" }, role: "button", aria: { haspopup: "true", expanded: "false" } do
              %i.fa.fa-filter
            .dropdown-menu
              = link_to "All", reviews_path(order: params[:order]), style: params[:status].blank? ? "font-weight:bold;" : "", class: "dropdown-item"
              - DataRequest::STATUS.each do |label, value|
                = link_to label.titleize, reviews_path(order: params[:order], status: value), style: params[:status] == value ? "font-weight:bold;" : "", class: "dropdown-item"
        %th
          = link_to "Data Request", reviews_path(order: (params[:order] == "agreements.id desc" ? "agreements.id" : "agreements.id desc"), status: params[:status], tag_id: params[:tag_id], search: params[:search])
        %th.d-none.d-sm-table-cell.nowrap
          = link_to "Submitted", reviews_path(order: (params[:order] == "agreements.last_submitted_at desc" ? "agreements.last_submitted_at" : nil), status: params[:status], tag_id: params[:tag_id], search: params[:search])
        %th.d-none.d-md-table-cell.nowrap
          = link_to "Expires", reviews_path(order: (params[:order] == "agreements.expiration_date desc" ? "agreements.expiration_date" : "agreements.expiration_date desc"), status: params[:status], tag_id: params[:tag_id], search: params[:search])
        %th.d-none.d-xl-table-cell Reviewers
        %th.d-none.d-xl-table-cell Datasets
        %th.d-none.d-xl-table-cell.nowrap
          Tags
          .dropdown{ style: "display: inline-block" }
            = link_to "#", data: { target: "#", toggle: "dropdown" }, role: "button", aria: { haspopup: "true", expanded: "false" } do
              %i.fa.fa-filter
            .dropdown-menu.dropdown-menu-right
              = link_to "All", reviews_path(order: params[:order]), style: params[:tag_id].blank? ? "font-weight:bold;" : "", class: "dropdown-item"
              - Tag.review_tags.pluck(:name, :id).each do |label, value|
                = link_to label.titleize, reviews_path(order: params[:order], tag_id: value), style: params[:tag_id].to_s == value.to_s ? "font-weight:bold;" : "", class: "dropdown-item"

    - @data_requests.each do |data_request|
      %tr
        %td= status_helper(data_request)
        %td
          = profile_picture_tag data_request.user, size: 18, style: "vertical-align:text-bottom;width:18px"
          = link_to data_request.name_with_id, review_path(data_request)
        %td.d-none.d-sm-table-cell.nowrap
          - if data_request.resubmitted_at
            = data_request.resubmitted_at.strftime("%Y-%m-%d")
            = link_to "#", rel: "tooltip", title: "Resubmitted", data: { object: "suppress-click", container: "body", placement: "right" } do
              %i.fa.fa-info-circle
          - elsif data_request.submitted_at
            = data_request.submitted_at.strftime("%Y-%m-%d")
        %td.d-none.d-md-table-cell.nowrap
          - if data_request.expiration_date
            = data_request.expiration_date.strftime("%Y-%m-%d")
        %td.d-none.d-xl-table-cell.nowrap= render "reviews/reviewers", data_request: data_request
        %td.d-none.d-xl-table-cell
          - data_request.datasets.order(:release_date, :name).each do |dataset|
            = render "datasets/mini", dataset: dataset
        %td.d-none.d-xl-table-cell= render "reviews/tags", data_request: data_request

  .center-horizontally= paginate @data_requests, theme: "bootstrap"
- else
  - if params[:voted] == "0"
    .jumbotron
      .text-center.text-muted Voting complete!
  - else
    .jumbotron
      .text-center.text-muted No data requests found.
