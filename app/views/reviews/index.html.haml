- @title = "Reviews"

- content_for :body_class do
  brand-background

- content_for :header do
  .header-container
    .container
      %h1.page-heading
        .pull-right
          = link_to download_or("Export CSV"), export_agreements_path(format: "csv"), class: "btn btn-accent btn-shadow" if current_user.system_admin?
          = render "layouts/per_page", per_page: 40, object_count: @agreements.total_count
        = @title

= render "search/simple", url: reviews_path

%table.table.table-striped.table-borderless.table-hover
  %thead.table-light
    %tr
      %th
        = link_to "Status", reviews_path(order: (params[:order] == "agreements.status desc" ? "agreements.status" : "agreements.status desc"), status: params[:status], tag_id: params[:tag_id], search: params[:search])
        .dropdown{ style: "display: inline-block" }
          = link_to "#", data: { target: "#", toggle: "dropdown" }, role: "button", aria: { haspopup: "true", expanded: "false" } do
            %i.fa.fa-filter
          .dropdown-menu
            = link_to "All", reviews_path(order: params[:order]), style: params[:status].blank? ? "font-weight:bold;" : "", class: "dropdown-item"
            - Agreement::STATUS.each do |label, value|
              = link_to label.titleize, reviews_path(order: params[:order], status: value), style: params[:status] == value ? "font-weight:bold;" : "", class: "dropdown-item"
      %th
        = link_to "Agreement", reviews_path(order: (params[:order] == "agreements.id desc" ? "agreements.id" : "agreements.id desc"), status: params[:status], tag_id: params[:tag_id], search: params[:search])
        = render "search/toggle"
      %th.d-none.d-sm-table-cell.nowrap
        = link_to "Submitted", reviews_path(order: (params[:order] == "agreements.last_submitted_at desc" ? "agreements.last_submitted_at" : nil), status: params[:status], tag_id: params[:tag_id], search: params[:search])
      %th.d-none.d-sm-table-cell.nowrap
        = link_to "Expires", reviews_path(order: (params[:order] == "agreements.expiration_date desc" ? "agreements.expiration_date" : "agreements.expiration_date desc"), status: params[:status], tag_id: params[:tag_id], search: params[:search])
      %th.d-none.d-lg-table-cell Reviewers
      %th.d-none.d-lg-table-cell Datasets
      %th.d-none.d-lg-table-cell
        Tags
        .dropdown{ style: "display: inline-block" }
          = link_to "#", data: { target: "#", toggle: "dropdown" }, role: "button", aria: { haspopup: "true", expanded: "false" } do
            %i.fa.fa-filter
          .dropdown-menu.dropdown-menu-right
            = link_to "All", reviews_path(order: params[:order]), style: params[:tag_id].blank? ? "font-weight:bold;" : "", class: "dropdown-item"
            - Tag.review_tags.pluck(:name, :id).each do |label, value|
              = link_to label.titleize, reviews_path(order: params[:order], tag_id: value), style: params[:tag_id].to_s == value.to_s ? "font-weight:bold;" : "", class: "dropdown-item"

  - @agreements.each do |agreement|
    %tr
      %td= status_helper(agreement)
      %td
        = image_tag agreement.user.avatar_url(18), style: "vertical-align:text-bottom;width:18px"
        = link_to agreement.name_with_id, review_path(agreement)
      %td.d-none.d-sm-table-cell
        - if agreement.resubmitted_at
          = agreement.resubmitted_at.strftime("%Y-%m-%d")
          = link_to "#", rel: "tooltip", title: "Resubmitted", data: { object: "suppress-click", container: "body", placement: "right" } do
            %i.fa.fa-info-circle
        - elsif agreement.submitted_at
          = agreement.submitted_at.strftime("%Y-%m-%d")
      %td.d-none.d-sm-table-cell.nowrap
        - if agreement.expiration_date
          = agreement.expiration_date.strftime("%Y-%m-%d")
      %td.d-none.d-lg-table-cell.nowrap= render "reviews/reviewers", agreement: agreement
      %td.d-none.d-lg-table-cell
        - agreement.datasets.order(:release_date, :name).each do |dataset|
          = render "datasets/mini", dataset: dataset
      %td.d-none.d-lg-table-cell= render "reviews/tags", agreement: agreement

.center-horizontally= paginate @agreements, theme: "bootstrap-small"
