- @title = 'Reviews'

- content_for :body_class do
  brand-background

- content_for :header do
  .header-container
    .container
      %h1.page-heading
        .pull-right
          = link_to download_or('Export CSV'), export_agreements_path(format: 'csv'), class: 'btn btn-accent btn-shadow' if current_user.system_admin?
          = render 'layouts/per_page', per_page: 40, object_count: @agreements.total_count
        = @title

= render 'search/simple', url: reviews_path

.dashboard-container.box-shadow
  .table-responsive
    %table.table.table-striped.table-borderless.table-hover
      %thead
        %tr
          %th
            = link_to 'Status', reviews_path(order: (params[:order] == 'agreements.status desc' ? 'agreements.status' : 'agreements.status desc'), status: params[:status], tag_id: params[:tag_id], search: params[:search])
            .dropdown{ style: 'display: inline-block' }
              = link_to '#', data: { target: '#', toggle: 'dropdown' }, role: 'button', aria: { haspopup: 'true', expanded: 'false' } do
                %span.glyphicon.glyphicon-filter
              %ul.dropdown-menu
                %li= link_to 'All', reviews_path(order: params[:order]), style: params[:status].blank? ? 'font-weight:bold;' : ''
                - Agreement::STATUS.each do |label, value|
                  %li= link_to label.titleize, reviews_path(order: params[:order], status: value), style: params[:status] == value ? 'font-weight:bold;' : ''
          %th
            = link_to 'Agreement', reviews_path(order: (params[:order] == 'agreements.id desc' ? 'agreements.id' : 'agreements.id desc'), status: params[:status], tag_id: params[:tag_id], search: params[:search])
            = render 'search/toggle'
          %th.nowrap
            = link_to 'Submitted', reviews_path(order: (params[:order] == 'agreements.last_submitted_at desc' ? 'agreements.last_submitted_at' : nil), status: params[:status], tag_id: params[:tag_id], search: params[:search])
          %th.nowrap
            = link_to 'Expires', reviews_path(order: (params[:order] == 'agreements.expiration_date desc' ? 'agreements.expiration_date' : 'agreements.expiration_date desc'), status: params[:status], tag_id: params[:tag_id], search: params[:search])
          %th Reviewers
          %th Datasets
          %th
            Tags
            .dropdown{ style: 'display: inline-block' }
              = link_to '#', data: { target: '#', toggle: 'dropdown' }, role: 'button', aria: { haspopup: 'true', expanded: 'false' } do
                %span.glyphicon.glyphicon-filter
              %ul.dropdown-menu.dropdown-menu-right
                %li= link_to 'All', reviews_path(order: params[:order]), style: params[:tag_id].blank? ? 'font-weight:bold;' : ''
                - Tag.review_tags.pluck(:name, :id).each do |label, value|
                  %li= link_to label.titleize, reviews_path(order: params[:order], tag_id: value), style: params[:tag_id].to_s == value.to_s ? 'font-weight:bold;' : ''

      - @agreements.each do |agreement|
        %tr
          %td= status_helper(agreement)
          %td.nowrap
            = image_tag agreement.user.avatar_url(18), style: 'vertical-align:text-bottom;width:18px'
            = link_to agreement.name_with_id, review_path(agreement)
          %td
            - if agreement.resubmitted_at
              = agreement.resubmitted_at.strftime("%Y-%m-%d")
              = link_to '#', rel: 'tooltip', title: 'Resubmitted', data: { object: 'suppress-click', container: 'body', placement: 'right' } do
                %span.glyphicon.glyphicon-info-sign
            - elsif agreement.submitted_at
              = agreement.submitted_at.strftime("%Y-%m-%d")
          %td.nowrap
            - if agreement.expiration_date
              = agreement.expiration_date.strftime('%Y-%m-%d')
          %td.nowrap= render 'reviews/reviewers', agreement: agreement
          %td
            - agreement.datasets.order(:release_date, :name).each do |dataset|
              = render 'datasets/mini', dataset: dataset
          %td= render 'reviews/tags', agreement: agreement

.center= paginate @agreements, theme: 'bootstrap-small'
