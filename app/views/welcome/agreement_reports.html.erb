<div class="page-header">
  <h1>Agreement Reports</h1>
</div>

<% @agreements = Agreement.current %>

<table class="table table-striped" style="table-layout:fixed">
  <thead>
    <tr>
      <th>Status</th>
      <% Agreement::STATUS.each do |label, status| %>
        <% status = nil if status == 'started' %>
        <% temp_agreement = Agreement.new(status: status) %>
        <th><%= status_helper(temp_agreement) %></th>
      <% end %>
      <th>Total</th>
    </tr>
  </thead>
  <tfoot>
    <tr>
      <th>Total</th>
      <% Agreement::STATUS.each do |label, status| %>
        <% status = nil if status == 'started' %>
        <% count = @agreements.where(status: status).count %>
        <th><%= link_to count, agreements_path(status: status || 'started') %></th>
      <% end %>
      <th><%= link_to @agreements.count, agreements_path %></th>
    </tr>
  </tfoot>

  <% Tag.review_tags.order(:name).each do |tag| %>
    <tr>
      <td><%= tag.name %></td>
      <% Agreement::STATUS.each do |label, status| %>
        <% status = nil if status == 'started' %>
        <% count = @agreements.where(status: status).with_tag(tag.id).count %>
        <td><%= link_to (count == 0 ? '-' : count), agreements_path(status: status || 'started', tag_id: tag.id) %></td>
      <% end %>
      <td><%= link_to @agreements.with_tag(tag.id).count, agreements_path(tag_id: tag.id) %></td>
    </tr>
  <% end %>
</table>

<table class="table table-striped" style="table-layout:fixed">
  <thead>
    <tr>
      <th>Month</th>
      <th>Submitted</th>
      <th>Approved</th>
    </tr>
  </thead>
  <tfoot>
    <tr>
      <% agreement_events = AgreementEvent.with_current_agreement.where(event_type: ['user_submitted', 'principal_reviewer_approved']) %>
      <th>Total</th>
      <th>
        <% count = agreement_events.select{|ae| ae.event_type == 'user_submitted'}.count %>
        <%= count == 0 ? '-' : count %>
      </th>
      <th>
        <% count = agreement_events.select{|ae| ae.event_type == 'principal_reviewer_approved'}.count %>
        <%= count == 0 ? '-' : count %>
      </th>
    </tr>
  </tfoot>
  <% AgreementEvent.with_current_agreement.where(event_type: ['user_submitted', 'principal_reviewer_approved']).order(:event_at).group_by{|ae| [ae.event_at.year, ae.event_at.month]}.each do |(year, month), agreement_events| %>
    <tr>
      <td><%= Date::ABBR_MONTHNAMES[month] %> <%= year %></td>
      <td>
        <% count = agreement_events.select{|ae| ae.event_type == 'user_submitted'}.count %>
        <%= count == 0 ? '-' : count %>
      </td>
      <td>
        <% count = agreement_events.select{|ae| ae.event_type == 'principal_reviewer_approved'}.count %>
        <%= count == 0 ? '-' : count %>
      </td>
    </tr>
  <% end %>
</table>
